{% macro cross_table(method, samples, matching_percent, matching_matches, fifth_indices, job_info) %}

  <table>
    <tr>
      <td style="font-size: 13px;color: black">#</td>
      <td style="font-size: 13px;color: black">family</td>
      <td style="font-size: 13px;color: black">version</td>
      <td></td>
        <td style="font-size: 13px;color: black">ID</td>
        <td style="font-size: 13px;color: black">Bit</td>
        <td style="font-size: 13px;color: black">FNs</td>
        <td style="font-size: 13px;color: black" colspan="{{ samples|length }}">Matrix</td>
    </tr>
    
    <tr>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    {% for id in fifth_indices %}
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td align="middle" style="font-size: 10px;color: black">{{id}}</td>
    {% endfor %}
    </tr>

    {% for sample in samples %}
      {% set outer_loop = loop %}
      <tr class="sample-row" style="border: 0px solid black; line-height: 0.7em;">
        <td class="result clickable" style="display: none;">{{ sample_to_job_id[sample.sample_id|string] }}</td>
        <td class="sha256" style="font-size: 13px; min-width: 100px;">{{ format_sha_short_clipboard(sample.sha256) }}</td>
        <td class="" style="padding: 0 5px; font-size: 13px">{{sample.family}}</td>
        <td class="" style="padding: 0 5px; font-size: 13px">{{sample.version}}</td>
        <td><a class="btn btn-outline-dark btn-sm" style="padding: 1px; width: 25px; height: 25px;" id="{{method}}_sample_{{ sample.sample_id }}_edit" role="button" data-bs-toggle="modal" data-bs-target="#editSampleModal" data-bs-islibrary="{{ sample.is_library }}"  data-bs-version="{{ sample.version }}"  data-bs-sampleid="{{ sample.sample_id }}" data-bs-familyname="{{ sample.family }}"><i class="fa-solid fa-pen-to-square"></i></a></td>
        <td class="id clickable" style="padding: 0 5px; font-size: 13px;color: black">{{ sample.sample_id }}</td>
        <td class="" style="padding: 0 5px; font-size: 13px">{{sample.bitness}}</td>
        <td class="" style="padding: 0 5px; font-size: 13px;color: black">{{sample.statistics['num_functions']}}</td>
      {% for sample2 in samples %}
        <td><span onclick="window.location.href='{{ sample_to_job_id[sample.sample_id|string] }}?samid={{ sample2.sample_id }}'";" class="hint--top" data-hint="MCRIT: {{ '%.2f%%'|format(matching_percent[sample.sample_id|string][sample2.sample_id|string]) }} ({{ matching_matches[sample.sample_id|string][sample2.sample_id|string] }} matches) &#10;
            {{ sample.sample_id }}: {{sample.sha256[:8]}} -- {{ sample.family }} {{ sample.version }} -- ({{sample.statistics['num_functions']}} func)
            &#10;vs.&#10;
            {{ sample2.sample_id }}: {{sample2.sha256[:8]}} -- {{ sample2.family }} {{ sample2.version }} -- ({{sample2.statistics['num_functions']}} func)" 
            style="background-color: #{{ score_to_color(matching_percent[sample.sample_id|string][sample2.sample_id|string]) }}; width: 25px; height: 25px; "></span>
        </td>
      {% endfor %}
      </tr>
    {% endfor %}
  </table>
{% endmacro %}

{% from 'table/column_table.html' import job_column_table %}
{% from 'table/links.html' import format_pichash, format_function_id, format_family_name, format_family_id, format_sample_id, format_sha_short_clipboard, clipboard_btn %}

{% extends 'base.html' %}
{% block title%}
Results for Job: {{ job_info.job_id }}
{% endblock %}
{% block style %}

<script>
  $(document).ready(function(){
    $("td.clickable").click(function(){
      var result = $(this).parent().children("td.result").text();
      window.location.href="/data/result/"+result;
    });
  });
  $( function() {
    $( "#sortable" ).sortable();
  } );
  function changeorder() {
    var array1 = document.getElementById('sortable').children;
    var array2 = []
    for (let i = 0; i < array1.length; i++) {
        array2.push(array1[i].innerHTML.split(' ')[0]);} 
    var result = "{{ job_info.job_id|safe }}";
    window.location.href="/data/result/"+result+"?custom="+array2;

  }
</script>
{% endblock %} 
{% block content %}


<script>
  var button_clicked = false;
  $(document).ready(function(){
    var editSampleModal = document.getElementById('editSampleModal');
    editSampleModal.addEventListener('show.bs.modal', function (event) {
    // Button that triggered the modal
    var button = event.relatedTarget;
    // Extract info from data-bs-* attributes
    var family_name = button.getAttribute('data-bs-familyname');
    var sample_id = button.getAttribute('data-bs-sampleid');
    var version = button.getAttribute('data-bs-version');
    var is_library = button.getAttribute('data-bs-islibrary');
    // Update the modal's content.
    var modalTitle = editSampleModal.querySelector('.modal-title');
    var modalBodyFamilyName = editSampleModal.querySelector('.modal-body #sample_family_name');
    var modalBodyVersion = editSampleModal.querySelector('.modal-body #sample_version');
    var modalBodySampleId = editSampleModal.querySelector('.modal-body #sample_id');
    var modalBodyLibrary = editSampleModal.querySelector('.modal-body #sample_is_library');
  
    modalTitle.textContent = 'Change Data for Sample ' + sample_id;
    modalBodyFamilyName.value = family_name;
    modalBodyVersion.value = version;
    modalBodySampleId.value = sample_id;
    if (is_library == "True") {
      modalBodyLibrary.checked = true;
    }
    else {
      modalBodyLibrary.checked = false;
    }
    })
  });
</script>

<!-- Modal -->
<div class="modal fade" id="editSampleModal" tabindex="-1" aria-labelledby="editSampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSampleModalLabel">Modify Sample</h5>
      </div>
      <div class="modal-body">
          <form action='{{ url_for("explore.modifySample") }}'' method="POST" style="width: 80%">
            <input type="text" class="form-control" name="sample_id" id="sample_id" hidden value="">
            <input type="text" class="form-control" name="redirection_job_id" id="redirection_job_id" hidden value="{{ job_info.job_id }}">
          <div class="form-group mb-3">
            <label for="sample_family_name" class="col-form-label">Family Name:</label>
            <input type="text" class="form-control" name="sample_family_name" id="sample_family_name" maxlength="64">
          </div>
          <div class="form-group mb-3">
            <label for="sample_version" class="col-form-label">Version:</label>
            <input class="form-control" name="sample_version" id="sample_version" maxlength="64">
          </div>
          <div class="form-group mb-3">
            <input type="checkbox" value="" name="sample_is_library" id="sample_is_library">
            &nbsp;&nbsp;
            <label for="sample_is_library" class="col-form-label">Sample is Library?</label>
          </div>
          <div class="form-group mb-3">
            <input type="checkbox" value="" name="sample_delete" id="sample_delete" onclick='toggle_delete_sample(this);'>
            &nbsp;&nbsp;
            <label for="sample_delete" class="col-form-label">Delete Sample</label>
          </div>
          <div>
            <button type="button" class="btn btn-secondary mb-3" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary mb-3">Submit Changes</button>
            <button type="submit" id="button_delete_sample" class="btn btn-danger mb-3" hidden>Delete Sample</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
  <script>
    function toggle_delete_sample(cb) {
    var deleteSampleButton = document.getElementById('button_delete_sample');
    if (cb.checked) {
      deleteSampleButton.hidden = false;
    } else {
      deleteSampleButton.hidden = true;
    }
  }
  </script>




<h1>Results for Job: {{ job_info.method }}</h1>
{{ job_column_table(job_info, show_created=False, show_started=False, show_finished=False) }}

<p>Cross Comparison of {{ samples["unweighted"]|length }} samples in the data set. You can order the samples in this list per drag and drop to change the order in the matrices.</p>
<div class="container">
    <div class="row">
      <div class="col-sm-auto">
        <ul style="list-style: none" id="sortable">
            {% for sample in samples["unweighted"] %}
            <li>{{ sample.sample_id ~' '~ sample.family ~ ' ' ~ sample.version}}</li>
            {% endfor %}
          </ul>
      </div>
      <div class="col-sm-auto align-self-center mb-3">
        <button onclick="changeorder()"type="button" class="btn btn-primary ">Change order</button> 
        <button onclick="window.location.href='{{ url_for('data.result', job_id=job_info.job_id) }}'" type="button" class="btn btn-primary ">Reset order</button> 
      </div>
    </div>
  </div>

<ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link show active" id="pills-unweighted-tab" data-bs-toggle="pill" data-bs-target="#pills-unweighted" type="button" role="tab" aria-controls="pills-unweighted" aria-selected="true">unweighted</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-score_weighted-tab" data-bs-toggle="pill" data-bs-target="#pills-score_weighted" type="button" role="tab" aria-controls="pills-score_weighted" aria-selected="false">score_weighted</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-frequency_weighted-tab" data-bs-toggle="pill" data-bs-target="#pills-frequency_weighted" type="button" role="tab" aria-controls="pills-frequency_weighted" aria-selected="false">frequency_weighted</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-nonlib_unweighted-tab" data-bs-toggle="pill" data-bs-target="#pills-nonlib_unweighted" type="button" role="tab" aria-controls="pills-nonlib_unweighted" aria-selected="false">nonlib_unweighted</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-nonlib_score_weighted-tab" data-bs-toggle="pill" data-bs-target="#pills-nonlib_score_weighted" type="button" role="tab" aria-controls="pills-nonlib_score_weighted" aria-selected="false">nonlib_score_weighted</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pills-nonlib_frequency_weighted-tab" data-bs-toggle="pill" data-bs-target="#pills-nonlib_frequency_weighted" type="button" role="tab" aria-controls="pills-nonlib_frequency_weighted" aria-selected="false">nonlib_frequency_weighted</button>
      </li>
  </ul>


<div class="tab-content" id="pills-tabContent">

    {% for method in matching_percent.keys() %}
      <div class="tab-pane fade {% if method=='unweighted' %}show active{%endif%}" id="pills-{{ method }}" role="tabpanel" aria-labelledby="pills-{{ method }}-tab">
          <center> 
            {{ cross_table(method, samples[method], matching_percent[method], matching_matches[method], sample_indices[method], job_info) }}
          </center>
      </div>
    {% endfor %}

  </div>
{% endblock %}


